package tetrahedra

import (
	"fmt"
	"github.com/notargets/gocfd/utils"
	"math"
)

// BarycentricQuadPoint represents a quadrature point in barycentric coordinates with weight
type BarycentricQuadPoint struct {
	Xi0, Xi1, Xi2, Xi3 float64 // Barycentric coordinates
	W                  float64 // Weight
}

// QuadraturePoint represents a quadrature point in both barycentric and Cartesian coordinates
type QuadraturePoint struct {
	// Barycentric coordinates (sum to 1)
	Xi0, Xi1, Xi2, Xi3 float64
	// Cartesian coordinates for unit simplex
	R, S, T float64
	// Weight (scaled for integration over unit simplex)
	W float64
}

// TetrahedralQuadrature represents a quadrature rule for the unit simplex tetrahedron
type TetrahedralQuadrature struct {
	Order  int
	Degree int // Polynomial degree that can be integrated exactly
	Points []QuadraturePoint
}

// ShunnHamTetrahedralQuadData contains the static quadrature data
// indexed by order (1-6)
var ShunnHamTetrahedralQuadData = [][]BarycentricQuadPoint{
	{}, // index 0 unused
	// N 1: 1 point, degree 1
	{
		{Xi0: 0.25, Xi1: 0.25, Xi2: 0.25, Xi3: 0.25, W: 1.0},
	},
	// N 2: 4 points, degree 2
	{
		{Xi0: 0.5854101966249680, Xi1: 0.1381966011250110, Xi2: 0.1381966011250110, Xi3: 0.1381966011250110, W: 0.25},
		{Xi0: 0.1381966011250110, Xi1: 0.5854101966249680, Xi2: 0.1381966011250110, Xi3: 0.1381966011250110, W: 0.25},
		{Xi0: 0.1381966011250110, Xi1: 0.1381966011250110, Xi2: 0.5854101966249680, Xi3: 0.1381966011250110, W: 0.25},
		{Xi0: 0.1381966011250110, Xi1: 0.1381966011250110, Xi2: 0.1381966011250110, Xi3: 0.5854101966249680, W: 0.25},
	},
	// N 3: 10 points, degree 3
	{
		// First 4 points (vertex points)
		{Xi0: 0.7784952948213300, Xi1: 0.0738349017262234, Xi2: 0.0738349017262234, Xi3: 0.0738349017262234, W: 0.0476331348432089},
		{Xi0: 0.0738349017262234, Xi1: 0.7784952948213300, Xi2: 0.0738349017262234, Xi3: 0.0738349017262234, W: 0.0476331348432089},
		{Xi0: 0.0738349017262234, Xi1: 0.0738349017262234, Xi2: 0.7784952948213300, Xi3: 0.0738349017262234, W: 0.0476331348432089},
		{Xi0: 0.0738349017262234, Xi1: 0.0738349017262234, Xi2: 0.0738349017262234, Xi3: 0.7784952948213300, W: 0.0476331348432089},
		// Next 6 points (edge points)
		{Xi0: 0.4062443438840510, Xi1: 0.4062443438840510, Xi2: 0.0937556561159491, Xi3: 0.0937556561159491, W: 0.1349112434378610},
		{Xi0: 0.4062443438840510, Xi1: 0.0937556561159491, Xi2: 0.4062443438840510, Xi3: 0.0937556561159491, W: 0.1349112434378610},
		{Xi0: 0.4062443438840510, Xi1: 0.0937556561159491, Xi2: 0.0937556561159491, Xi3: 0.4062443438840510, W: 0.1349112434378610},
		{Xi0: 0.0937556561159491, Xi1: 0.4062443438840510, Xi2: 0.4062443438840510, Xi3: 0.0937556561159491, W: 0.1349112434378610},
		{Xi0: 0.0937556561159491, Xi1: 0.4062443438840510, Xi2: 0.0937556561159491, Xi3: 0.4062443438840510, W: 0.1349112434378610},
		{Xi0: 0.0937556561159491, Xi1: 0.0937556561159491, Xi2: 0.4062443438840510, Xi3: 0.4062443438840510, W: 0.1349112434378610},
	},
	// N 4: 20 points, degree 5
	{
		// First 4 points
		{Xi0: 0.9029422158182680, Xi1: 0.0323525947272439, Xi2: 0.0323525947272439, Xi3: 0.0323525947272439, W: 0.0070670747944695},
		{Xi0: 0.0323525947272439, Xi1: 0.9029422158182680, Xi2: 0.0323525947272439, Xi3: 0.0323525947272439, W: 0.0070670747944695},
		{Xi0: 0.0323525947272439, Xi1: 0.0323525947272439, Xi2: 0.9029422158182680, Xi3: 0.0323525947272439, W: 0.0070670747944695},
		{Xi0: 0.0323525947272439, Xi1: 0.0323525947272439, Xi2: 0.0323525947272439, Xi3: 0.9029422158182680, W: 0.0070670747944695},
		// Next 12 points
		{Xi0: 0.2626825838877790, Xi1: 0.6165965330619370, Xi2: 0.0603604415251421, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.6165965330619370, Xi1: 0.2626825838877790, Xi2: 0.0603604415251421, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.2626825838877790, Xi1: 0.0603604415251421, Xi2: 0.6165965330619370, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.6165965330619370, Xi1: 0.0603604415251421, Xi2: 0.2626825838877790, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.2626825838877790, Xi1: 0.0603604415251421, Xi2: 0.0603604415251421, Xi3: 0.6165965330619370, W: 0.0469986689718877},
		{Xi0: 0.6165965330619370, Xi1: 0.0603604415251421, Xi2: 0.0603604415251421, Xi3: 0.2626825838877790, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.2626825838877790, Xi2: 0.6165965330619370, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.6165965330619370, Xi2: 0.2626825838877790, Xi3: 0.0603604415251421, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.2626825838877790, Xi2: 0.0603604415251421, Xi3: 0.6165965330619370, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.6165965330619370, Xi2: 0.0603604415251421, Xi3: 0.2626825838877790, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.0603604415251421, Xi2: 0.2626825838877790, Xi3: 0.6165965330619370, W: 0.0469986689718877},
		{Xi0: 0.0603604415251421, Xi1: 0.0603604415251421, Xi2: 0.6165965330619370, Xi3: 0.2626825838877790, W: 0.0469986689718877},
		// Last 4 points
		{Xi0: 0.3097693042728620, Xi1: 0.3097693042728620, Xi2: 0.3097693042728620, Xi3: 0.0706920871814129, W: 0.1019369182898680},
		{Xi0: 0.3097693042728620, Xi1: 0.3097693042728620, Xi2: 0.0706920871814129, Xi3: 0.3097693042728620, W: 0.1019369182898680},
		{Xi0: 0.3097693042728620, Xi1: 0.0706920871814129, Xi2: 0.3097693042728620, Xi3: 0.3097693042728620, W: 0.1019369182898680},
		{Xi0: 0.0706920871814129, Xi1: 0.3097693042728620, Xi2: 0.3097693042728620, Xi3: 0.3097693042728620, W: 0.1019369182898680},
	},
	// N 5: 35 points, degree 6
	{
		// Group 1: 4 points
		{Xi0: 0.9197896733368800, Xi1: 0.0267367755543735, Xi2: 0.0267367755543735, Xi3: 0.0267367755543735, W: 0.0021900463965388},
		{Xi0: 0.0267367755543735, Xi1: 0.9197896733368800, Xi2: 0.0267367755543735, Xi3: 0.0267367755543735, W: 0.0021900463965388},
		{Xi0: 0.0267367755543735, Xi1: 0.0267367755543735, Xi2: 0.9197896733368800, Xi3: 0.0267367755543735, W: 0.0021900463965388},
		{Xi0: 0.0267367755543735, Xi1: 0.0267367755543735, Xi2: 0.0267367755543735, Xi3: 0.9197896733368800, W: 0.0021900463965388},
		// Group 2: 12 points
		{Xi0: 0.1740356302468940, Xi1: 0.7477598884818090, Xi2: 0.0391022406356488, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.7477598884818090, Xi1: 0.1740356302468940, Xi2: 0.0391022406356488, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.1740356302468940, Xi1: 0.0391022406356488, Xi2: 0.7477598884818090, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.7477598884818090, Xi1: 0.0391022406356488, Xi2: 0.1740356302468940, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.1740356302468940, Xi1: 0.0391022406356488, Xi2: 0.0391022406356488, Xi3: 0.7477598884818090, W: 0.0143395670177665},
		{Xi0: 0.7477598884818090, Xi1: 0.0391022406356488, Xi2: 0.0391022406356488, Xi3: 0.1740356302468940, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.1740356302468940, Xi2: 0.7477598884818090, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.7477598884818090, Xi2: 0.1740356302468940, Xi3: 0.0391022406356488, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.1740356302468940, Xi2: 0.0391022406356488, Xi3: 0.7477598884818090, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.7477598884818090, Xi2: 0.0391022406356488, Xi3: 0.1740356302468940, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.0391022406356488, Xi2: 0.1740356302468940, Xi3: 0.7477598884818090, W: 0.0143395670177665},
		{Xi0: 0.0391022406356488, Xi1: 0.0391022406356488, Xi2: 0.7477598884818090, Xi3: 0.1740356302468940, W: 0.0143395670177665},
		// Group 3: 6 points
		{Xi0: 0.4547545999844830, Xi1: 0.4547545999844830, Xi2: 0.0452454000155172, Xi3: 0.0452454000155172, W: 0.0250305395686746},
		{Xi0: 0.4547545999844830, Xi1: 0.0452454000155172, Xi2: 0.4547545999844830, Xi3: 0.0452454000155172, W: 0.0250305395686746},
		{Xi0: 0.4547545999844830, Xi1: 0.0452454000155172, Xi2: 0.0452454000155172, Xi3: 0.4547545999844830, W: 0.0250305395686746},
		{Xi0: 0.0452454000155172, Xi1: 0.4547545999844830, Xi2: 0.4547545999844830, Xi3: 0.0452454000155172, W: 0.0250305395686746},
		{Xi0: 0.0452454000155172, Xi1: 0.4547545999844830, Xi2: 0.0452454000155172, Xi3: 0.4547545999844830, W: 0.0250305395686746},
		{Xi0: 0.0452454000155172, Xi1: 0.0452454000155172, Xi2: 0.4547545999844830, Xi3: 0.4547545999844830, W: 0.0250305395686746},
		// Group 4: 12 points
		{Xi0: 0.5031186450145980, Xi1: 0.2232010379623150, Xi2: 0.2232010379623150, Xi3: 0.0504792790607720, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.5031186450145980, Xi2: 0.2232010379623150, Xi3: 0.0504792790607720, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.2232010379623150, Xi2: 0.5031186450145980, Xi3: 0.0504792790607720, W: 0.0479839333057554},
		{Xi0: 0.5031186450145980, Xi1: 0.2232010379623150, Xi2: 0.0504792790607720, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.5031186450145980, Xi2: 0.0504792790607720, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.2232010379623150, Xi2: 0.0504792790607720, Xi3: 0.5031186450145980, W: 0.0479839333057554},
		{Xi0: 0.5031186450145980, Xi1: 0.0504792790607720, Xi2: 0.2232010379623150, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.0504792790607720, Xi2: 0.5031186450145980, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.2232010379623150, Xi1: 0.0504792790607720, Xi2: 0.2232010379623150, Xi3: 0.5031186450145980, W: 0.0479839333057554},
		{Xi0: 0.0504792790607720, Xi1: 0.5031186450145980, Xi2: 0.2232010379623150, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.0504792790607720, Xi1: 0.2232010379623150, Xi2: 0.5031186450145980, Xi3: 0.2232010379623150, W: 0.0479839333057554},
		{Xi0: 0.0504792790607720, Xi1: 0.2232010379623150, Xi2: 0.2232010379623150, Xi3: 0.5031186450145980, W: 0.0479839333057554},
		// Group 5: 1 point (centroid)
		{Xi0: 0.25, Xi1: 0.25, Xi2: 0.25, Xi3: 0.25, W: 0.0931745731195340},
	},
	// N 6: 56 points, degree 8
	{
		// Group 1: 4 points
		{Xi0: 0.9551438045408220, Xi1: 0.0149520651530592, Xi2: 0.0149520651530592, Xi3: 0.0149520651530592, W: 0.0010373112336140},
		{Xi0: 0.0149520651530592, Xi1: 0.9551438045408220, Xi2: 0.0149520651530592, Xi3: 0.0149520651530592, W: 0.0010373112336140},
		{Xi0: 0.0149520651530592, Xi1: 0.0149520651530592, Xi2: 0.9551438045408220, Xi3: 0.0149520651530592, W: 0.0010373112336140},
		{Xi0: 0.0149520651530592, Xi1: 0.0149520651530592, Xi2: 0.0149520651530592, Xi3: 0.9551438045408220, W: 0.0010373112336140},
		// Group 2: 12 points
		{Xi0: 0.7799760084415400, Xi1: 0.1518319491659370, Xi2: 0.0340960211962615, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.1518319491659370, Xi1: 0.7799760084415400, Xi2: 0.0340960211962615, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.7799760084415400, Xi1: 0.0340960211962615, Xi2: 0.1518319491659370, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.1518319491659370, Xi1: 0.0340960211962615, Xi2: 0.7799760084415400, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.7799760084415400, Xi1: 0.0340960211962615, Xi2: 0.0340960211962615, Xi3: 0.1518319491659370, W: 0.0096016645399480},
		{Xi0: 0.1518319491659370, Xi1: 0.0340960211962615, Xi2: 0.0340960211962615, Xi3: 0.7799760084415400, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.7799760084415400, Xi2: 0.1518319491659370, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.1518319491659370, Xi2: 0.7799760084415400, Xi3: 0.0340960211962615, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.7799760084415400, Xi2: 0.0340960211962615, Xi3: 0.1518319491659370, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.1518319491659370, Xi2: 0.0340960211962615, Xi3: 0.7799760084415400, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.0340960211962615, Xi2: 0.7799760084415400, Xi3: 0.1518319491659370, W: 0.0096016645399480},
		{Xi0: 0.0340960211962615, Xi1: 0.0340960211962615, Xi2: 0.1518319491659370, Xi3: 0.7799760084415400, W: 0.0096016645399480},
		// Group 3: 12 points
		{Xi0: 0.3549340560639790, Xi1: 0.5526556431060170, Xi2: 0.0462051504150017, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.5526556431060170, Xi1: 0.3549340560639790, Xi2: 0.0462051504150017, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.3549340560639790, Xi1: 0.0462051504150017, Xi2: 0.5526556431060170, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.5526556431060170, Xi1: 0.0462051504150017, Xi2: 0.3549340560639790, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.3549340560639790, Xi1: 0.0462051504150017, Xi2: 0.0462051504150017, Xi3: 0.5526556431060170, W: 0.0164493976798232},
		{Xi0: 0.5526556431060170, Xi1: 0.0462051504150017, Xi2: 0.0462051504150017, Xi3: 0.3549340560639790, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.3549340560639790, Xi2: 0.5526556431060170, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.5526556431060170, Xi2: 0.3549340560639790, Xi3: 0.0462051504150017, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.3549340560639790, Xi2: 0.0462051504150017, Xi3: 0.5526556431060170, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.5526556431060170, Xi2: 0.0462051504150017, Xi3: 0.3549340560639790, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.0462051504150017, Xi2: 0.3549340560639790, Xi3: 0.5526556431060170, W: 0.0164493976798232},
		{Xi0: 0.0462051504150017, Xi1: 0.0462051504150017, Xi2: 0.5526556431060170, Xi3: 0.3549340560639790, W: 0.0164493976798232},
		// Group 4: 12 points
		{Xi0: 0.5381043228880020, Xi1: 0.2281904610687610, Xi2: 0.2281904610687610, Xi3: 0.0055147549744775, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.5381043228880020, Xi2: 0.2281904610687610, Xi3: 0.0055147549744775, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.2281904610687610, Xi2: 0.5381043228880020, Xi3: 0.0055147549744775, W: 0.0153747766513310},
		{Xi0: 0.5381043228880020, Xi1: 0.2281904610687610, Xi2: 0.0055147549744775, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.5381043228880020, Xi2: 0.0055147549744775, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.2281904610687610, Xi2: 0.0055147549744775, Xi3: 0.5381043228880020, W: 0.0153747766513310},
		{Xi0: 0.5381043228880020, Xi1: 0.0055147549744775, Xi2: 0.2281904610687610, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.0055147549744775, Xi2: 0.5381043228880020, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.2281904610687610, Xi1: 0.0055147549744775, Xi2: 0.2281904610687610, Xi3: 0.5381043228880020, W: 0.0153747766513310},
		{Xi0: 0.0055147549744775, Xi1: 0.5381043228880020, Xi2: 0.2281904610687610, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.0055147549744775, Xi1: 0.2281904610687610, Xi2: 0.5381043228880020, Xi3: 0.2281904610687610, W: 0.0153747766513310},
		{Xi0: 0.0055147549744775, Xi1: 0.2281904610687610, Xi2: 0.2281904610687610, Xi3: 0.5381043228880020, W: 0.0153747766513310},
		// Group 5: 12 points
		{Xi0: 0.1961837595745600, Xi1: 0.3523052600879940, Xi2: 0.3523052600879940, Xi3: 0.0992057202494530, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.1961837595745600, Xi2: 0.3523052600879940, Xi3: 0.0992057202494530, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.3523052600879940, Xi2: 0.1961837595745600, Xi3: 0.0992057202494530, W: 0.0293520118375230},
		{Xi0: 0.1961837595745600, Xi1: 0.3523052600879940, Xi2: 0.0992057202494530, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.1961837595745600, Xi2: 0.0992057202494530, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.3523052600879940, Xi2: 0.0992057202494530, Xi3: 0.1961837595745600, W: 0.0293520118375230},
		{Xi0: 0.1961837595745600, Xi1: 0.0992057202494530, Xi2: 0.3523052600879940, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.0992057202494530, Xi2: 0.1961837595745600, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.3523052600879940, Xi1: 0.0992057202494530, Xi2: 0.3523052600879940, Xi3: 0.1961837595745600, W: 0.0293520118375230},
		{Xi0: 0.0992057202494530, Xi1: 0.1961837595745600, Xi2: 0.3523052600879940, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.0992057202494530, Xi1: 0.3523052600879940, Xi2: 0.1961837595745600, Xi3: 0.3523052600879940, W: 0.0293520118375230},
		{Xi0: 0.0992057202494530, Xi1: 0.3523052600879940, Xi2: 0.3523052600879940, Xi3: 0.1961837595745600, W: 0.0293520118375230},
		// Group 6: 4 points
		{Xi0: 0.5965649956210170, Xi1: 0.1344783347929940, Xi2: 0.1344783347929940, Xi3: 0.1344783347929940, W: 0.0366291366405108},
		{Xi0: 0.1344783347929940, Xi1: 0.5965649956210170, Xi2: 0.1344783347929940, Xi3: 0.1344783347929940, W: 0.0366291366405108},
		{Xi0: 0.1344783347929940, Xi1: 0.1344783347929940, Xi2: 0.5965649956210170, Xi3: 0.1344783347929940, W: 0.0366291366405108},
		{Xi0: 0.1344783347929940, Xi1: 0.1344783347929940, Xi2: 0.1344783347929940, Xi3: 0.5965649956210170, W: 0.0366291366405108},
	},
}

// NewShunnHamQuadrature creates a Shunn-Ham quadrature rule for the unit simplex
// Unit simplex has vertices at (0,0,0), (1,0,0), (0,1,0), (0,0,1)
// Volume = 1/6
func NewShunnHamQuadrature(order int) (*TetrahedralQuadrature, error) {
	if order < 1 || order > 6 {
		return nil, fmt.Errorf("order %d not implemented (valid orders: 1-6)", order)
	}

	// Get degree that can be integrated exactly
	degrees := []int{0, 1, 2, 3, 5, 6, 8} // index by order

	// Convert barycentric points to full quadrature points
	baryPoints := ShunnHamTetrahedralQuadData[order]
	points := make([]QuadraturePoint, len(baryPoints))

	for i, bp := range baryPoints {
		// Convert to Cartesian coordinates for unit simplex
		r, s, t := bp.Xi1, bp.Xi2, bp.Xi3

		points[i] = QuadraturePoint{
			Xi0: bp.Xi0,
			Xi1: bp.Xi1,
			Xi2: bp.Xi2,
			Xi3: bp.Xi3,
			R:   r,
			S:   s,
			T:   t,
			W:   bp.W,
		}
	}

	return &TetrahedralQuadrature{
		Order:  order,
		Degree: degrees[order],
		Points: points,
	}, nil
}

// GetRSTWUnit returns slices of r, s, t coordinates and weights for all points
// for the unit simplex [0,1]³ with vertices at (0,0,0), (1,0,0), (0,1,0), (0,0,1)
// Weights are scaled by 1/6 for the unit simplex volume
func (tq *TetrahedralQuadrature) GetRSTWUnit() (r, s, t, w []float64) {
	n := len(tq.Points)
	r = make([]float64, n)
	s = make([]float64, n)
	t = make([]float64, n)
	w = make([]float64, n)

	// Scale factor for unit simplex volume (1/6)
	volumeScale := 1.0 / 6.0

	for i, pt := range tq.Points {
		r[i] = pt.R
		s[i] = pt.S
		t[i] = pt.T
		w[i] = pt.W * volumeScale
	}

	return
}

// GetRSTWReference returns slices of r, s, t coordinates and weights for all points
// for the reference tetrahedron [-1,1]³ with vertices at (-1,-1,-1), (1,-1,-1), (-1,1,-1), (-1,-1,1)
// Weights are scaled by 4/3 for the reference tetrahedron volume
func (tq *TetrahedralQuadrature) GetRSTWReference() (r, s, t, w []float64) {
	n := len(tq.Points)
	r = make([]float64, n)
	s = make([]float64, n)
	t = make([]float64, n)
	w = make([]float64, n)

	// Volume scale factor for [-1,1]³ tetrahedron (volume = 4/3)
	volumeScale := 4.0 / 3.0

	for i, pt := range tq.Points {
		// Transform from barycentric to reference tetrahedron coordinates
		// Using the transformation:
		// r = -1 + 2*xi1 + 2*xi2 + 2*xi3
		// s = -1 + 2*xi2 + 2*xi3
		// t = -1 + 2*xi3
		r[i] = -1.0 + 2.0*pt.Xi1 + 2.0*pt.Xi2 + 2.0*pt.Xi3
		s[i] = -1.0 + 2.0*pt.Xi2 + 2.0*pt.Xi3
		t[i] = -1.0 + 2.0*pt.Xi3
		w[i] = pt.W * volumeScale
	}

	return
}

// VerifyWeightSum checks if the weights sum to 1 (NOT 1/6 as in the original)
// The paper's weights are normalized to 1, not to the volume of the unit simplex
func (tq *TetrahedralQuadrature) VerifyWeightSum() (sum float64, isValid bool) {
	sum = 0.0
	for _, pt := range tq.Points {
		sum += pt.W
	}
	expectedSum := 1.0
	tolerance := 1e-14
	isValid = math.Abs(sum-expectedSum) < tolerance
	return sum, isValid
}

// VerifyBarycentricCoordinates checks if all barycentric coordinates sum to 1
func (tq *TetrahedralQuadrature) VerifyBarycentricCoordinates() bool {
	tolerance := 1e-14
	for i, pt := range tq.Points {
		sum := pt.Xi0 + pt.Xi1 + pt.Xi2 + pt.Xi3
		if math.Abs(sum-1.0) > tolerance {
			fmt.Printf("Point %d: barycentric sum = %g (should be 1)\n", i, sum)
			return false
		}
	}
	return true
}

// GetNodesShunnHam returns the quadrature nodes (R, S,
// T) for a tetrahedron of polynomial order P
// The nodes are sourced from the Shunn-Ham quadrature rule with matching number of points
// sufficient to interpolate a polynomial of order P
func GetNodesShunnHam(P int) (R, S, T utils.Vector) {
	quadOrder := P + 1
	if quadOrder < 1 || quadOrder > 6 {
		panic(fmt.Sprintf("polynomial order P=%d not available in quadrature"+
			" rules", P))
	}
	// Get the quadrature rule
	quad, err := NewShunnHamQuadrature(quadOrder)
	if err != nil {
		// This should not happen with valid quadOrder
		panic(fmt.Sprintf("failed to create quadrature for order %d: %v", quadOrder, err))
	}

	// Extract R, S, T coordinates for the reference tetrahedron
	r, s, t, _ := quad.GetRSTWReference()

	// Create utils.Vector instances
	R = utils.NewVector(len(r), r)
	S = utils.NewVector(len(s), s)
	T = utils.NewVector(len(t), t)

	return
}
